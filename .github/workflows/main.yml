name: Deploy backend

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Notify Telegram (start)
              run: |
                  curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage \
                  -d chat_id=${{ secrets.TG_CHAT_ID }} \
                  -d parse_mode=HTML \
                  -d text=$'üöÄ <b>–î–µ–ø–ª–æ–π backend –Ω–∞—á–∞–ª—Å—è</b>\n<b>Repo:</b> <code>${{ github.repository }}</code>\n<b>Commit:</b> <code>${{ github.sha }}</code>'

            - name: Deploy via SSH
              uses: appleboy/ssh-action@v1.1.0
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USER }}
                  key: ${{ secrets.PRIVATE_KEY }}
                  script: |
                      cd /opt/provportal/backend
                      git pull origin main
                      docker compose up -d --build

            - name: Notify Telegram (success)
              if: success()
              run: |
                  curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage \
                  -d chat_id=${{ secrets.TG_CHAT_ID }} \
                  -d parse_mode=HTML \
                  -d text=$'‚úÖ <b>–î–µ–ø–ª–æ–π backend –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ</b>\n<b>Commit:</b> <code>${{ github.sha }}</code>'

            - name: Notify Telegram (failure)
              if: failure()
              run: |
                  curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage \
                  -d chat_id=${{ secrets.TG_CHAT_ID }} \
                  -d parse_mode=HTML \
                  -d text=$'‚ùå <b>–î–µ–ø–ª–æ–π backend –∑–∞–≤–µ—Ä—à–µ–Ω –±–µ–∑—É—Å–ø–µ—à–Ω–æ</b>\n<b>Commit:</b> <code>${{ github.sha }}</code>\n<b>–ü—Ä–∏—á–∏–Ω–∞:</b> —Å–º–æ—Ç—Ä–∏ –ª–æ–≥–∏\n<a href='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'>–û—Ç–∫—Ä—ã—Ç—å GitHub Actions</a>'
